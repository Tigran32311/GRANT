<script setup>
import { VFileUpload } from 'vuetify/labs/VFileUpload'
import { VDateInput } from 'vuetify/labs/VDateInput'
import { VTimePicker } from 'vuetify/labs/VTimePicker'

</script>

<template>
  <v-snackbar
      close-on-content-click
      timeout="-1"
      location="top"
      v-model="notification"
      :color="notificationSnack"
  >
    <v-alert
        :text="notificationText"
        closable
        :type="notificationType"
        class="ma-0 pa-0 w-100 h-100"
    ></v-alert>
  </v-snackbar>
  <div>
    <div class="text-h5 font-weight-bold pa-10">
      Загрузить видео
    </div>
    <form class="px-10" @submit.prevent="sendForm">
      <div class="text-subtitle-1">Номер учетного пункта указывается согласно <a href="https://скдф.рф/roads" target="_blank">реестру</a></div>
      <v-text-field
          v-model="formModel.pointKM"
          label="Номер учетного пункта"
          required
      ></v-text-field>
      <v-date-input
          label="Дата учета"
          v-model="formModel.registrationDate"
      ></v-date-input>
      <v-text-field
          v-model="formModel.registrationStart"
          :active="menu2"
          :focus="menu2"
          label="Время начала учета"
          prepend-icon="mdi-clock-time-four-outline"
          readonly
      >
        <v-menu
            v-model="menu2"
            :close-on-content-click="false"
            activator="parent"
            transition="scale-transition"
        >
          <v-time-picker
              v-if="menu2"
              v-model="formModel.registrationStart"
              format="24hr"
              full-width
          ></v-time-picker>
        </v-menu>
      </v-text-field>
      <v-text-field
          v-model="formModel.registrationEnd"
          :active="menu3"
          :focus="menu3"
          label="Время конца учета"
          prepend-icon="mdi-clock-time-four-outline"
          readonly
      >
        <v-menu
            v-model="menu3"
            :close-on-content-click="false"
            activator="parent"
            transition="scale-transition"
        >
          <v-time-picker
              v-if="menu3"
              v-model="formModel.registrationEnd"
              format="24hr"
              full-width
          ></v-time-picker>
        </v-menu>
      </v-text-field>
<!--      <v-text-field-->
<!--          label="Километр"-->
<!--          v-model="formModel.pointKM"-->
<!--          required-->
<!--      ></v-text-field>-->
      <v-text-field
          label="Количество полос"
          v-model="formModel.numberOfLanes"
          required
      ></v-text-field>
      <v-text-field
          label="Должность проверяющего"
          v-model="formModel.inspectorPost"
          required
      ></v-text-field>
      <v-text-field
          label="ФИО проверяющего"
          v-model="formModel.inspectorFio"
          required
      ></v-text-field>
      <v-autocomplete
          label="Регион"
          v-model="formModel.region.id"
          :items=regions
          item-title="name"
          item-value="id"

          chips
          deletable-chips
          filled

      ></v-autocomplete>
      <v-autocomplete
          label="Дорога"
          v-model="formModel.road.id"
          :items=roads
          item-title="name"
          item-value="id"

          chips
          deletable-chips
          filled

      ></v-autocomplete>
      <div class="text-right" style="color: var(--warning)">* Здесь необходимо указать координаты, где проводился учет интенсивности. При копировании координаты из Яндекс карт первое число будет широта, второе долгота.</div>
      <div class="d-md-flex flex-row ga-2">
        <v-text-field
            label="Широта"
            v-model="formModel.shirota"
            required
        ></v-text-field>
        <v-text-field
            label="Долгота"
            v-model="formModel.dolgota"
            required
        ></v-text-field>
      </div>
      <v-checkbox v-model="formModel.visibleStatus" label="Доступен для просмотра пользователям?"></v-checkbox>
      <div class="text-subtitle-1">Загрузите видеоролик (доступные форматы: mp4, avi)*</div>
      <div class="mb-5">
      <v-file-upload
          clearable
          v-model="fileVideo"
          density="comfortable"
          variant="comfortable"
          title="Выберите или перетащите файл"
          browse-text="Local Filesystem"
          divider-text="or choose locally"
      ></v-file-upload></div>
      <v-btn
          class="me-4 mb-4 text-none px-15"
          color="var(--button-green)"
          style="color: white"
          size="large"
          type="submit"
      >
        Отправить
      </v-btn>
    </form>
  </div>
</template>

<script>
  import httpResource from "@/http/httpResource.js";
  import { useCookies } from "vue3-cookies";
  import store from "@/store/index.js";
  import {
    addRoadFunc,
    getRegions,
    getRoads,
    performLogout,
    refreshToken,
    sendFormUtil
  } from "@/utils/util.js";
  import {dateFormat} from "@/utils/helper.js";
  import router from "@/router/index.js";
  const { cookies } = useCookies();
  export default {
    name: "CreateReportForm",
    components: {
      VFileUpload,
    },
    data: () => ({
      time: "",
      menu2: false,
      time2: "",
      menu3: false,
      fileVideo: null,
      roadModel: {},
      roads: [],
      regions: [],
      formModel: {
        pointKM: "",
        registrationDate: null,
        registrationStart: null,
        registrationEnd: null ,
        visibleStatus: true,
        dolgota: null,
        shirota: null,
        region: {
          id: null
        },
        road: {
          id: null
        },
        inspectorFio: "",
        inspectorPost: "",
        numberOfLanes: "",
      },
      notification: false,
      notificationText: "Успешно",
      notificationType: "success",
      notificationSnack: "",
    }),
    created() {
      this.getRoads()
      this.getRegions()
    },
    methods: {
      setNotification(type,snack,text) {
        this.notificationType=type
        this.notificationSnack=snack
        this.notificationText=text
        this.notification=true
      },
      async getRoads() {
        try {
          const response = await getRoads()
          if (response.status===200) {
            this.roads=response.data
          } else {
            this.setNotification("error","var(--error)",response.message)
          }
        } catch (error) {
          console.log(error)
        }
      },
      async getRegions() {
        try {
          const response = await getRegions()
          if (response.status===200) {
            this.regions=response.data
          } else {
            this.setNotification("error","var(--error)",response.message)
          }
        } catch (error) {
          console.log(error)
        }
      },
      async sendForm() {
        try {
          const data = new FormData()
          data.append("file",this.fileVideo)
          this.formModel.registrationDate = dateFormat(this.formModel.registrationDate)
          this.formModel.registrationStart = this.formModel.registrationStart+":00"
          this.formModel.registrationEnd = this.formModel.registrationEnd+":00"
          data.append("videoData",new Blob([JSON.stringify(this.formModel)],{type: 'application/json'}))
          const response = await sendFormUtil(data)
          if (response.status === 200) {
            this.setNotification("success","success","Видеоролик успешно загружен и поставлен в очередь на обработку")
            const timeout = window.setTimeout(function () {
              location.reload()
            }, 800)
          } else {
            this.setNotification("error","var(--error)",response.message)
          }
        } catch (error) {
          console.log(error)
        }
      }
    },
  }
</script>

<style scoped>

</style>